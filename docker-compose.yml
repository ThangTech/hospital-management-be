# =====================================================
# Hospital Management Microservices - Docker Compose
# =====================================================
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose down           # Stop all services
#   docker-compose logs -f        # View logs
# =====================================================

services:
  # =====================================================
  # SQL Server Database
  # =====================================================
  hospital-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: hospital-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SA_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "${SA_PASSWORD}" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # SQL Server Initialization (runs once)
  # =====================================================
  db-init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: db-init
    depends_on:
      hospital-db:
        condition: service_healthy
    volumes:
      - ./docker/init-db.sql:/init-db.sql
    environment:
      - SA_PASSWORD=${SA_PASSWORD}
    entrypoint: ["/bin/bash", "-c"]
    command: 
      - |
        echo "Waiting for SQL Server to be ready..."
        sleep 10
        /opt/mssql-tools18/bin/sqlcmd -S hospital-db -U sa -P "$${SA_PASSWORD}" -C -i /init-db.sql
        echo "Database initialization completed!"
    networks:
      - hospital-network

  # =====================================================
  # Identity Service (Authentication)
  # =====================================================
  identity-service:
    build:
      context: .
      dockerfile: IdentityService/Dockerfile
    container_name: identity-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5283:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # Admin Service
  # =====================================================
  admin-service:
    build:
      context: .
      dockerfile: AdminService/Dockerfile
    container_name: admin-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5270:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # BacSi Service (Doctors)
  # =====================================================
  bacsi-service:
    build:
      context: .
      dockerfile: BacSiService/Dockerfile
    container_name: bacsi-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5163:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # BenhNhan Service (Patients)
  # =====================================================
  benhnhan-service:
    build:
      context: .
      dockerfile: BenhNhanService/Dockerfile
    container_name: benhnhan-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5146:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # YTa Service (Medical Assistants)
  # =====================================================
  yta-service:
    build:
      context: .
      dockerfile: YtaService/Dockerfile
    container_name: yta-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5259:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # KhoaPhong Service (Departments)
  # =====================================================
  khoaphong-service:
    build:
      context: .
      dockerfile: KhoaPhongService/Dockerfile
    container_name: khoaphong-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5178:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # HoaDon Service (Invoices)
  # =====================================================
  hoadon-service:
    build:
      context: .
      dockerfile: HoaDonService/Dockerfile
    container_name: hoadon-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=hospital-db;Database=hospital_manage;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5231:80"
    depends_on:
      hospital-db:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped

  # =====================================================
  # API Gateway (Ocelot)
  # =====================================================
  api-gateway:
    build:
      context: .
      dockerfile: ApiGateway/Dockerfile
    container_name: api-gateway
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:80
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    ports:
      - "5076:80"
    depends_on:
      - identity-service
      - admin-service
      - bacsi-service
      - benhnhan-service
      - yta-service
      - khoaphong-service
      - hoadon-service
    networks:
      - hospital-network
    restart: unless-stopped

# =====================================================
# Networks
# =====================================================
networks:
  hospital-network:
    driver: bridge

# =====================================================
# Volumes
# =====================================================
volumes:
  sqlserver_data:
    driver: local
